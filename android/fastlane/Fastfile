default_platform(:android)

platform :android do

  # Internal Testing Deployment
  desc "Upload to Google Play Internal Testing"
  lane :internal_test do
    # Extract version details from pubspec.yaml
    pubspec_path = File.expand_path("../../pubspec.yaml", __dir__)

    version_line = File.read(pubspec_path).match(/version: (\d+\.\d+\.\d+)\+(\d+)/)
    current_version_name = version_line[1]
    current_version_code = version_line[2].to_i

    new_version_code = current_version_code + 1

    escaped_current_version_code = current_version_code.to_s.gsub("+", "\\+")
    escaped_new_version_code = new_version_code.to_s.gsub("+", "\\+")

    puts "Updating version in pubspec.yaml..."
    sh "sed -i 's/version: #{current_version_name}+#{escaped_current_version_code}/version: #{current_version_name}+#{escaped_new_version_code}/' #{pubspec_path}"

    # Confirm that the update worked
    puts "Updated pubspec.yaml content:"
    sh "cat #{pubspec_path} | grep version"

    # Ensure Flutter recognizes changes
    sh "flutter pub get"

    # Clean and rebuild
    sh "flutter clean"
    sh "flutter build appbundle"
    upload_to_play_store(
      track: "internal",   # Internal testing track
      json_key: "./fastlane/deploy.json",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      release_status: "completed",  # âœ… Use `release_status` instead
    )
  end

  # Production Deployment
  desc "Upload to Google Play Production"
  lane :production do
    # Extract version details from pubspec.yaml
    pubspec_path = File.expand_path("../../pubspec.yaml", __dir__)

    version_line = File.read(pubspec_path).match(/version: (\d+\.\d+\.\d+)\+(\d+)/)
    current_version_name = version_line[1]
    current_version_code = version_line[2].to_i

    new_version_code = current_version_code + 1

    escaped_current_version_code = current_version_code.to_s.gsub("+", "\\+")
    escaped_new_version_code = new_version_code.to_s.gsub("+", "\\+")

    puts "Updating version in pubspec.yaml..."
    sh "sed -i 's/version: #{current_version_name}+#{escaped_current_version_code}/version: #{current_version_name}+#{escaped_new_version_code}/' #{pubspec_path}"

    # Confirm that the update worked
    puts "Updated pubspec.yaml content:"
    sh "cat #{pubspec_path} | grep version"

    # Ensure Flutter recognizes changes
    sh "flutter pub get"

    # Clean and rebuild
    sh "flutter clean"
    sh "flutter build appbundle"
    upload_to_play_store(
      track: "production",   # Change this to 'production' for production deployment
      json_key: "./fastlane/deploy.json",
      aab: "../build/app/outputs/bundle/release/app-release.aab",
      release_status: "completed",  # Set to 'completed' to publish
    )
  end

end
